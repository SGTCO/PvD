name: Build APK from Web

on:
  release:
    types: [published]

jobs:
  build-apk:
    runs-on: ubuntu-latest

    steps:
      # å–å¾—ä½ çš„ repo
      - name: Checkout repository
        uses: actions/checkout@v4

      # å®‰è£ Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      # å®‰è£ Java 17 (Temurin)
      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      # å®‰è£ Capacitor CLI
      - name: Install Capacitor CLI
        run: |
          npm install -g @capacitor/cli @capacitor/android

      # å»ºç«‹ android å°ˆæ¡ˆè³‡æ–™å¤¾
      - name: Generate Android project (Capacitor)
        run: |
          npx cap init "PvDWebApp" "com.sgtco.pvd" --web-dir app/public
          npx cap add android

      # ğŸš« ç§»é™¤ @capacitor/android å…§å»ºçš„ Java 21 toolchain
      - name: Force downgrade Capacitor Android toolchain to Java 17
        run: |
          echo "ğŸ”§ Removing toolchain JDK 21 requirement from @capacitor/android ..."
          find node_modules/@capacitor/android -type f -name "build.gradle*" -print0 | xargs -0 sed -i \
            -e '/toolchain {/,/}/d' \
            -e '/languageVersion\.set(JavaLanguageVersion\.of(21))/d' \
            -e 's/JavaLanguageVersion\.of(21)/JavaLanguageVersion.of(17)/g' \
            -e 's/JavaVersion.VERSION_21/JavaVersion.VERSION_17/g' \
            -e 's/jvmTarget = "21"/jvmTarget = "17"/g'
          echo "âœ… Capacitor Android toolchain patched to Java 17"

      # ğŸ”§ å¼·åˆ¶ Android Gradle ä½¿ç”¨ Java 17 ç·¨è­¯
      - name: Patch Android Gradle files to use Java 17 & diagnostics
        run: |
          set -eu
          echo "ğŸ”§ Patching Android Gradle config for Java 17..."
          find android -type f -name "build.gradle*" -print0 | while IFS= read -r -d '' file; do
            echo "Patching $file"
            sed -i '/sourceCompatibility/d' "$file" || true
            sed -i '/targetCompatibility/d' "$file" || true
            sed -i '/jvmTarget/d' "$file" || true
            cat <<'EOF' >> "$file"

            android {
                compileOptions {
                    sourceCompatibility = JavaVersion.VERSION_17
                    targetCompatibility = JavaVersion.VERSION_17
                }
            }

            kotlinOptions {
                jvmTarget = "17"
            }
          EOF
          done

          echo "âœ… Android Gradle files patched to Java 17"

      # ç¢ºèª Java ç‰ˆæœ¬
      - name: Verify Java version
        run: |
          java -version
          javac -version
          echo "JAVA_HOME=$JAVA_HOME"

      # ğŸ§© å»ºç«‹ Gradle Wrapperï¼ˆè‹¥ä¸å­˜åœ¨ï¼‰
      - name: Ensure Gradle Wrapper
        run: |
          cd android
          if [ ! -f gradlew ]; then
            echo "gradlew not found â€” installing Gradle wrapper..."
            gradle wrapper
          fi
          chmod +x gradlew

      # ğŸš€ ç·¨è­¯ APK
      - name: Build Android APK
        run: |
          cd android
          ./gradlew assembleDebug --no-daemon --stacktrace

      # ğŸ“¦ ä¸Šå‚³æˆå“åˆ° GitHub Artifacts
      - name: Upload APK Artifact
        uses: actions/upload-artifact@v4
        with:
          name: PvD-debug-apk
          path: android/app/build/outputs/apk/debug/*.apk
name: Build APK from Web

on:
  release:
    types: [published]

jobs:
  build-apk:
    runs-on: ubuntu-latest

    steps:
      # ğŸ§­ å–å¾— Repo
      - name: Checkout repository
        uses: actions/checkout@v4

      # âš™ï¸ è¨­å®š Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      # â˜• å®‰è£ Java 17 (Temurin)
      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      # ğŸ“¦ å®‰è£å‰ç«¯ä¾è³´ä¸¦ç·¨è­¯ Web å°ˆæ¡ˆ
      - name: Install dependencies & build web app
        working-directory: app
        run: |
          npm ci
          npm run build

      # âš¡ å»ºç«‹ Capacitor å°ˆæ¡ˆ
      - name: Generate Android project (Capacitor)
        working-directory: app
        run: |
          npx cap init "PvDWebApp" "com.sgtco.pvd" --web-dir public --npm-client npm
          npm install @capacitor/android
          npx cap add android

      # ğŸš« ä¿®æ­£ @capacitor/android çš„ JDK ç‰ˆæœ¬è¦æ±‚
      - name: Force downgrade Capacitor Android toolchain to Java 17
        working-directory: app
        run: |
          echo "ğŸ”§ Removing toolchain JDK 21 requirement from @capacitor/android ..."
          find node_modules/@capacitor/android -type f -name "build.gradle*" -print0 | xargs -0 sed -i \
            -e '/toolchain {/,/}/d' \
            -e '/languageVersion\.set(JavaLanguageVersion\.of(21))/d' \
            -e 's/JavaLanguageVersion\.of(21)/JavaLanguageVersion.of(17)/g' \
            -e 's/JavaVersion.VERSION_21/JavaVersion.VERSION_17/g' \
            -e 's/jvmTarget = "21"/jvmTarget = "17"/g'
          echo "âœ… Capacitor Android toolchain patched to Java 17"

      # ğŸ”§ å¼·åˆ¶ Android Gradle ä½¿ç”¨ Java 17 ç·¨è­¯
      - name: Patch Android Gradle files to use Java 17
        working-directory: app
        run: |
          echo "ğŸ”§ Patching Android Gradle config for Java 17..."
          find android -type f -name "build.gradle*" -print0 | while IFS= read -r -d '' file; do
            echo "Patching $file"
            sed -i '/sourceCompatibility/d' "$file" || true
            sed -i '/targetCompatibility/d' "$file" || true
            sed -i '/jvmTarget/d' "$file" || true
            cat <<'EOF' >> "$file"

            android {
                compileOptions {
                    sourceCompatibility = JavaVersion.VERSION_17
                    targetCompatibility = JavaVersion.VERSION_17
                }
            }

            kotlinOptions {
                jvmTarget = "17"
            }
          EOF
          done
          echo "âœ… Android Gradle files patched to Java 17"

      # â˜• é©—è­‰ Java ç‰ˆæœ¬
      - name: Verify Java version
        run: |
          java -version
          javac -version
          echo "JAVA_HOME=$JAVA_HOME"

      # ğŸ§© å»ºç«‹ Gradle Wrapperï¼ˆè‹¥ä¸å­˜åœ¨ï¼‰
      - name: Ensure Gradle Wrapper
        working-directory: app/android
        run: |
          if [ ! -f gradlew ]; then
            echo "gradlew not found â€” installing Gradle wrapper..."
            gradle wrapper
          fi
          chmod +x gradlew

      # ğŸš€ ç·¨è­¯ APK
      - name: Build Android APK
        working-directory: app/android
        run: |
          ./gradlew assembleDebug --no-daemon --stacktrace

      # ğŸ“¦ ä¸Šå‚³ APK æˆå“åˆ° Artifacts
      - name: Upload APK Artifact
        uses: actions/upload-artifact@v4
        with:
          name: PvD-debug-apk
          path: app/android/app/build/outputs/apk/debug/*.apk

      # ğŸª¶ è‡ªå‹•é™„åŠ åˆ° Releaseï¼ˆå¯é¸ï¼‰
      - name: Attach APK to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: app/android/app/build/outputs/apk/debug/*.apk
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
name: Build APK from Web

on:
  release:
    types: [published]

jobs:
  build-apk:
    runs-on: ubuntu-latest

    steps:
      # 🧭 取得 Repo
      - name: Checkout repository
        uses: actions/checkout@v4

      # ⚙️ 設定 Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      # ☕ 安裝 Java 17 (Temurin)
      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      # 📦 安裝前端依賴並編譯 Web 專案
      - name: Install dependencies & build web app
        working-directory: app
        run: |
          npm ci
          npm run build

      # ⚡ 建立 Capacitor 專案
      - name: Generate Android project (Capacitor)
        working-directory: app
        run: |
          npx cap init "PvDWebApp" "com.sgtco.pvd" --web-dir public --npm-client npm
          npm install @capacitor/android
          npx cap add android

      # 🚫 修正 @capacitor/android 的 JDK 版本要求
      - name: Force downgrade Capacitor Android toolchain to Java 17
        working-directory: app
        run: |
          echo "🔧 Removing toolchain JDK 21 requirement from @capacitor/android ..."
          find node_modules/@capacitor/android -type f -name "build.gradle*" -print0 | xargs -0 sed -i \
            -e '/toolchain {/,/}/d' \
            -e '/languageVersion\.set(JavaLanguageVersion\.of(21))/d' \
            -e 's/JavaLanguageVersion\.of(21)/JavaLanguageVersion.of(17)/g' \
            -e 's/JavaVersion.VERSION_21/JavaVersion.VERSION_17/g' \
            -e 's/jvmTarget = "21"/jvmTarget = "17"/g'
          echo "✅ Capacitor Android toolchain patched to Java 17"

      # 🔧 強制 Android Gradle 使用 Java 17 編譯
      - name: Patch Android Gradle files to use Java 17
        working-directory: app
        run: |
          echo "🔧 Patching Android Gradle config for Java 17..."
          find android -type f -name "build.gradle*" -print0 | while IFS= read -r -d '' file; do
            echo "Patching $file"
            sed -i '/sourceCompatibility/d' "$file" || true
            sed -i '/targetCompatibility/d' "$file" || true
            sed -i '/jvmTarget/d' "$file" || true
            cat <<'EOF' >> "$file"

            android {
                compileOptions {
                    sourceCompatibility = JavaVersion.VERSION_17
                    targetCompatibility = JavaVersion.VERSION_17
                }
            }

            kotlinOptions {
                jvmTarget = "17"
            }
          EOF
          done
          echo "✅ Android Gradle files patched to Java 17"

      # ☕ 驗證 Java 版本
      - name: Verify Java version
        run: |
          java -version
          javac -version
          echo "JAVA_HOME=$JAVA_HOME"

      # 🧩 建立 Gradle Wrapper（若不存在）
      - name: Ensure Gradle Wrapper
        working-directory: app/android
        run: |
          if [ ! -f gradlew ]; then
            echo "gradlew not found — installing Gradle wrapper..."
            gradle wrapper
          fi
          chmod +x gradlew

      # 🚀 編譯 APK
      - name: Build Android APK
        working-directory: app/android
        run: |
          ./gradlew assembleDebug --no-daemon --stacktrace

      # 📦 上傳 APK 成品到 Artifacts
      - name: Upload APK Artifact
        uses: actions/upload-artifact@v4
        with:
          name: PvD-debug-apk
          path: app/android/app/build/outputs/apk/debug/*.apk

      # 🪶 自動附加到 Release（可選）
      - name: Attach APK to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: app/android/app/build/outputs/apk/debug/*.apk
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}